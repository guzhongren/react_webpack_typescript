// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper dojo/_base/lang dojo/io-query ../../request ../../core/Accessor ../../core/LRUMap ../../core/promiseUtils ../../core/watchUtils ../../core/Error ../../core/HandleRegistry ../../core/Logger ../../core/accessorSupport/decorators ./Tilemap".split(" "),function(f,A,q,k,p,r,t,u,v,l,w,n,x,y,h,m){var z=y.getLogger("esri.layers.support.TilemapCache");f=function(f){function e(){var a=null!==f&&f.apply(this,
arguments)||this;a._handles=new x;a._pendingTilemapRequests={};a._availableLevels={};a.levels=5;a.cacheByteSize=2097152;a.request=t;return a}q(e,f);e.prototype.normalizeCtorArgs=function(a){var b=this;a=p.mixin({},a);this._constructOnly={};["cacheByteSize","layer","levels","request"].forEach(function(d){d in a&&("levels"===d&&2>=a[d]?z.error("Minimum levels for Tilemap is 3, but got ",a[d]):b._constructOnly[d]=a[d],delete a[d])});return a};e.prototype.initialize=function(){var a=this,b;for(b in this._constructOnly)this._set(b,
this._constructOnly[b]);this._constructOnly=null;this._tilemapCache=new v(this.cacheByteSize,{sizeOfFunction:function(a){return a.byteSize}});this._handles.add([this.watch(["layer.parsedUrl","layer.tileServers"],function(){return a._initializeTilemapDefinition()}),w.init(this,"layer.tileInfo.lods",function(b){return a._initializeAvailableLevels(b)},!0)]);this._initializeTilemapDefinition()};e.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null)};Object.defineProperty(e.prototype,
"size",{get:function(){return 1<<this.levels},enumerable:!0,configurable:!0});e.prototype.getTilemap=function(a,b,d){return this._tilemapFromCache(a,b,d,this._tmpTilemapDefinition)};e.prototype.fetchTilemap=function(a,b,d,c){var e=this;if(!this._availableLevels[a])return l.reject(new n("tilemap-cache:level-unavailable","Level "+a+" is unavailable in the service"));var f=this._tmpTilemapDefinition;if(a=this._tilemapFromCache(a,b,d,f))return l.resolve(a);var g=m.tilemapDefinitionId(f);a=this._pendingTilemapRequests[g];
a||(a=m.Tilemap.fromDefinition(f,c).then(function(a){e._tilemapCache.set(g,a);delete e._pendingTilemapRequests[g];return a}).otherwise(function(a){delete e._pendingTilemapRequests[g];return l.reject(a)}),this._pendingTilemapRequests[g]=a);return a};e.prototype.getAvailability=function(a,b,d){return this._availableLevels[a]?(a=this.getTilemap(a,b,d))?a.getAvailability(b,d):"unknown":"unavailable"};e.prototype.getAvailabilityUpsample=function(a,b,d,c){c.level=a;c.row=b;c.col=d;a=this.layer.tileInfo;
for(a.updateTileInfo(c);;)if(b=this.getAvailability(c.level,c.row,c.col),"unavailable"===b){if(!a.upsampleTile(c))return"unavailable"}else return b};e.prototype.fetchAvailability=function(a,b,d,c){return this._availableLevels[a]?this.fetchTilemap(a,b,d,c).always(function(c){return c instanceof m.Tilemap?(c=c.getAvailability(b,d),"unavailable"===c?l.reject(new n("tile-map:tile-unavailable","Tile is not available",{level:a,row:b,col:d})):c):"unknown"}):l.reject(new n("tilemap-cache:level-unavailable",
"Level "+a+" is unavailable in the service"))};e.prototype.fetchAvailabilityUpsample=function(a,b,d,c,e){var f=this;c.level=a;c.row=b;c.col=d;var g=this.layer.tileInfo;g.updateTileInfo(c);return this.fetchAvailability(a,b,d,e).otherwise(function(a){return g.upsampleTile(c)?f.fetchAvailabilityUpsample(c.level,c.row,c.col,c):l.reject(a)})};e.prototype._initializeTilemapDefinition=function(){if(this.layer.parsedUrl){var a=this.layer.parsedUrl,b=a.query;b&&b.token||!this.layer.token||(b=p.mixin(b,{token:this.layer.token}));
this._tilemapCache.clear();this._tmpTilemapDefinition={service:{url:a.path,query:b?r.objectToQuery(b):null,tileServers:this.layer.tileServers,request:this.request},width:this.size,height:this.size,level:0,row:0,col:0}}};e.prototype._tilemapFromCache=function(a,b,d,c){a=this._getTilemapDefinition(a,b,d,c);a=m.tilemapDefinitionId(a);return this._tilemapCache.get(a)};e.prototype._getTilemapDefinition=function(a,b,d,c){c.level=a;c.row=b-b%this.size;c.col=d-d%this.size;return c};e.prototype._initializeAvailableLevels=
function(a){var b=this;this._availableLevels={};a&&a.forEach(function(a){return b._availableLevels[a.level]=!0})};return e}(h.declared(u));k([h.property({readOnly:!0})],f.prototype,"levels",void 0);k([h.property({readOnly:!0,dependsOn:["levels"]})],f.prototype,"size",null);k([h.property({readOnly:!0})],f.prototype,"cacheByteSize",void 0);k([h.property({readOnly:!0})],f.prototype,"layer",void 0);k([h.property({readOnly:!0})],f.prototype,"request",void 0);return f=k([h.subclass("esri.layers.support.TilemapCache")],
f)});