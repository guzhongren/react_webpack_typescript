// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define(["../../core/declare","dojo/_base/array","../../Graphic","../../geometry/Polyline","./TrackManager"],function(p,l,q,r,t){return p([t],{declaredClass:"esri.layers.support.StreamTrackManager",constructor:function(a){this.inherited(arguments)},initialize:function(a){this.inherited(arguments)},addFeatures:function(a,e){function g(b,d){var c,k,a;h[b]||(h[b]=[]);b=h[b];0<f&&(d.length>f&&d.splice(0,d.length-f),k=d.length+b.length,k>f&&(c=b.splice(0,k-f)));k=d.length;for(a=0;a<k;a+=1)b.push(d[a]);
return{deletes:c,adds:d}}var h,b,k,f,c={},d={},n;if(e)return this.inherited(arguments),c;h=this.trackMap;b=this.layer;k=b._trackIdField;f=b.maximumTrackPoints||0;l.forEach(a,function(b){var a=b.attributes[k];b.visible&&(d[a]||(d[a]=[]),d[a].push(b))});for(n in d)d.hasOwnProperty(n)&&(b=g(n,d[n]),c[n]=b);return c},removeFeatures:function(a){var e=[],g=this.layer.objectIdField,h=this.layer._trackIdField;a&&(l.forEach(a,function(b){var a,f,c,d;f=b.attributes[h];a=b.attributes[g];if(c=this.trackMap[f])for(b=
0;b<c.length;b+=1)if(d=c[b],d.attributes[g]===a){this.trackMap[f].splice(b,1);-1===l.indexOf(f)&&e.push(f);break}},this),0<a.length&&this.refreshTracks(e))},drawTracks:function(a){function e(d){var a=b[d],c=a&&1<a.length,e,l,m;(m=g.trackLineMap[d])&&!c&&(h.remove(m),delete g.trackLineMap[d],m=null);if(!c)return!1;c=[];for(e=a.length-1;0<=e;--e)(l=a[e].geometry)&&c.push([l.x,l.y]);a={};a[f]=d;1<c.length&&(m?(d=m.geometry,d.removePath(0),d.addPath(c),m.setGeometry(d)):(m=new q(new r({paths:[c],spatialReference:k}),
null,a),h.add(m),g.trackLineMap[d]=m))}var g=this,h=this.container,b,k,f,c;if(h)if(b=this.trackMap,k=this.map.spatialReference,f=this.layer._trackIdField,a)l.forEach(a,function(a){e(a)});else for(c in b)b.hasOwnProperty(c)&&e(c)},refreshTracks:function(a){function e(a){var b,c;a=g[a]||[];b=a.length;for(c=0;c<b;c++)h._repaint(a[c],null,!0)}var g=this.trackMap,h=this.layer,b;this.drawTracks(a);if(a)l.forEach(a,function(a){e(a)});else for(b in g)g.hasOwnProperty(b)&&e(b)},destroy:function(){this.inherited(arguments);
this.trackLineMap=null}})});