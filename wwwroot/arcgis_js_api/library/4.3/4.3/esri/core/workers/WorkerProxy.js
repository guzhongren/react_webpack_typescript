// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define(["require","exports","dojo/Deferred"],function(l,m,k){return function(){function g(a,f,d){this.parentModule=a;this.worker=f;this.connection=d;this.msgCount=0;this.outgoingJobs={};this.incomingJobs={};this.msgCount=0;this.outgoingJobs={};this.incomingJobs={}}g.prototype.invoke=function(a,f,d,c){var b=this,e=++this.msgCount,h=new k(function(a){b.worker.postMessage({type:"\x3ccancel\x3e",id:e,connection:c,data:{reason:a}});b.outgoingJobs[e]&&delete b.outgoingJobs[e]});this.outgoingJobs[e]=h;this.worker.postMessage({type:a,
id:e,connection:c,data:f},d);return h.promise};g.prototype.message=function(a){var f=this;if(a&&a.data){var d=a.data.type;if(d){var c=a.data,b=a.data.id,e=a.data.connection;if("\x3cresponse\x3e"===d&&b){if(a=this.outgoingJobs[b])delete this.outgoingJobs[b],c.error?a.reject(c.error):a.resolve(c.data)}else"\x3ccancel\x3e"===d&&b?(a=this.incomingJobs[b])&&a.cancel(c.data.reason||"cancel"):(a=this.parentModule[d],"function"===typeof a&&(c=a.call(this.parentModule,c.data,this.connection),this.incomingJobs[b]=
c,c.then(function(a){f.worker.postMessage({type:"\x3cresponse\x3e",id:b,connection:e,data:a?a.data:null},a?a.buffers:[])}).otherwise(function(a){a||(a="Error encountered at method "+d);f.worker.postMessage({type:"\x3cresponse\x3e",id:b,connection:e,data:null,error:a})}).always(function(){delete f.incomingJobs[b]})))}}};return g}()});