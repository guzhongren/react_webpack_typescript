// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/accessorSupport/decorators dojo/promise/all ./graphics/Graphics3DLayerViewCore ./graphics/graphicUtils ./support/LayerViewUpdatingPercentage ../../layers/LayerView ../../../layers/FeatureLayer ../../../renderers/support/renderingInfoUtils ../../../layers/graphics/controllers/SnapshotController ../support/PromiseLightweight ../../../core/watchUtils ./support/projectExtentUtils ../../../core/Error ../../../core/promiseUtils ../../../layers/graphics/QueryEngine".split(" "),
function(c,A,m,e,d,n,p,q,r,t,u,v,w,x,l,y,h,k,z){c=f=function(c){function b(a){a=c.call(this)||this;a.controller=null;a.supportsDraping=!0;a._overlayUpdating=null;a._progressMaxNumNodes=0;a._eventHandles=[];a._controllerClientSideFiltering=!1;a._suspendResumeExtent=null;a.fullExtentInViewSpatialReference=null;a._isUpdating=!1;a._controllerCreated=!1;return a}m(b,c);Object.defineProperty(b.prototype,"drawingOrder",{set:function(a){this._layerViewCore.graphicsCore.setDrawingOrder(a);this._set("drawingOrder",
a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hasDraped",{get:function(){return this._layerViewCore.graphicsCore.hasDraped},enumerable:!0,configurable:!0});b.prototype.initialize=function(){var a=this;this._layerViewCore=new p({owner:this,layer:this.layer,spatialIndexRequired:!0,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,labelingEnabled:this.layer.isInstanceOf(u),elevationAlignmentEnabled:!0,verticalScaleEnabled:!0,updateSuspendResumeExtent:function(){return a.updateSuspendResumeExtent()},
updateClippingExtent:function(b){return a.updateClippingExtent(b)}});this.addResolvingPromise(this._layerViewCore.initialize());this.drawingOrder=this.view.getDrawingOrder(this.layer.uid);this.createController();this.addResolvingPromise(this.validateMaximumFeatureCount());this.addResolvingPromise(this.validateGeometryType());var b=y.toView(this).then(function(b){a.fullExtentInViewSpatialReference=b});b&&this.addResolvingPromise(b);this._evaluateUpdatingState()};b.prototype.destroy=function(){this._eventHandles.forEach(function(a){return a.remove()});
this._eventHandles=null;this.controller&&(this.controller.destroy(),this.controller=null);this._layerViewCore&&(this._layerViewCore.destroy(),this._layerViewCore=null);this.loadedGraphics=null};b.prototype.getRenderingInfo=function(a){if((a=v.getRenderingInfo(a,{renderer:this.layer.renderer}))&&a.color){var b=a.color;b[0]/=255;b[1]/=255;b[2]/=255}return a};b.prototype.getGraphicsFromStageObject=function(a,b){var g=a.getMetadata().graphicId,c=null;this.loadedGraphics&&this.loadedGraphics.some(function(a){return a.uid===
g?(c=a,!0):!1});a=new x.Promise;null!==c?a.done(c):a.reject();return a};b.prototype.getGraphics3DGraphics=function(){return this._layerViewCore.graphicsCore.getGraphics3DGraphics()};b.prototype.getGraphics3DGraphicsKeys=function(){return this._layerViewCore.graphicsCore.getGraphics3DGraphicsKeys()};b.prototype.getSymbolUpdateType=function(){return this._layerViewCore.graphicsCore.getSymbolUpdateType()};b.prototype.queryGraphics=function(){return this._queryEngine?this._queryEngine.queryFeatures():
this._rejectQuery()};b.prototype.queryFeatures=function(a){return this._queryEngine?this._queryEngine.queryFeatures(a):this._rejectQuery()};b.prototype.queryObjectIds=function(a){return this._queryEngine?this._queryEngine.queryObjectIds(a):this._rejectQuery()};b.prototype.queryFeatureCount=function(a){return this._queryEngine?this._queryEngine.queryFeatureCount(a):this._rejectQuery()};b.prototype.queryExtent=function(a){return this._queryEngine?this._queryEngine.queryExtent(a):this._rejectQuery()};
b.prototype.whenGraphicBounds=function(a){return this._layerViewCore.graphicsCore.whenGraphicBounds(a)};b.prototype._rejectQuery=function(){return k.reject(new h("FeatureLayerView3D","Not ready to execute query"))};b.prototype._notifySuspendedChange=function(){this.notifyChange("suspended")};b.prototype._notifyDrapedDataChange=function(){this.notifyChange("hasDraped");this.emit("draped-data-change")};b.prototype.canResume=function(){return this.inherited(arguments)&&this._layerViewCore&&this._layerViewCore.canResume()};
b.prototype._evaluateUpdatingState=function(){if(this._layerViewCore.elevationAlignment){var a;a=0+this._layerViewCore.elevationAlignment.numNodesUpdating();a+=this._layerViewCore.graphicsCore.numNodesUpdating();var b;b=(b=(b=(b=(b=!this._controllerCreated)||this.controller&&this.controller.updating)||this._overlayUpdating)||this._layerViewCore.graphicsCore.needsIdleUpdate())||!(this.view.basemapTerrain&&this.view.basemapTerrain.ready);var g;g=0<a||b||this._layerViewCore.spatialIndex.isUpdating();
this._progressMaxNumNodes=Math.max(a,this._progressMaxNumNodes);0===a&&(this._progressMaxNumNodes=1);this._isUpdating=g;this.notifyChange("updating");this._set("updatingPercentageValue",b?100:100*a/this._progressMaxNumNodes)}else this._isUpdating=!1,this.notifyChange("updating"),this._set("updatingPercentageValue",100)};b.prototype.isUpdating=function(){return this._isUpdating};b.prototype.createController=function(){var a=this,b=this.layer.createGraphicsController({layerView:this,options:{maxPageSize:300,
extent:this.view.clippingArea}});l.whenTrueOnce(this.view,"basemapTerrain.ready",function(){n([a,b]).then(function(b){b=b[1];b instanceof w&&(a.controller=b,a._eventHandles.push(a.controller.watch("updating",function(){return a._evaluateUpdatingState()})),a._eventHandles.push(l.whenFalseOnce(a,"suspended",function(){a.controller&&a.controller.startup()})));a.loadedGraphics=b.graphics;a._queryEngine=new z({features:a.loadedGraphics,objectIdField:a.layer.objectIdField});a._evaluateUpdatingState()}).always(function(){a._controllerCreated=
!0;a._evaluateUpdatingState()})})};b.prototype.updateClippingExtent=function(a){if(this.controller){if(this._controllerClientSideFiltering)return!1;this.controller.extent?(this.controller.extent=null,this._controllerClientSideFiltering=!0):this.controller.extent=a;return!0}return!1};b.prototype.updateSuspendResumeExtent=function(){return this._suspendResumeExtent=q.enlargeExtent(this._layerViewCore.graphicsCore.computedExtent,this._suspendResumeExtent,1.2)};b.prototype.validateGeometryType=function(){var a=
this.layer;switch(a.geometryType){case "multipatch":case "multipoint":return k.reject(new h("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:a.geometryType}))}};b.prototype.validateMaximumFeatureCount=function(){return 0>f.maximumFeatureCount||!this.layer.url?k.resolve():this.layer.queryFeatureCount().then(function(a){if(a>f.maximumFeatureCount)throw new h("featurelayerview3d:maximum-feature-count-exceeded","The maximum number of allowed features (${maximumFeatureCount}) has been exceeded (layer has ${numberOfFeatures} features)",
{maximumFeatureCount:f.maximumFeatureCount,numberOfFeatures:a});})};b.prototype.getStats=function(){var a=this._layerViewCore.graphicsCore.getGraphics3DGraphics(),b="null",c=this._suspendResumeExtent;c&&(b=[c[0],c[1],c[2],c[3]].map(function(a){return a.toPrecision(4)}).join(", "));var c="null",d=this._layerViewCore.graphicsCore.computedExtent;d&&(c=[d.xmin,d.ymin,d.xmax,d.ymax].map(function(a){return a.toPrecision(4)}).join(", "));return{numCollection:this.loadedGraphics.length,numGraphics:Object.keys(a).length,
numElevationUpdating:this._layerViewCore.elevationAlignment.numNodesUpdating(),numSpatialIndexUpdating:this._layerViewCore.spatialIndex.numNodesUpdating(),numGraphicsUpdating:this._layerViewCore.graphicsCore.numNodesUpdating(),visibilityFrustum:this._layerViewCore.frustumVisibility.canResume(),visibilityScale:this._layerViewCore.scaleVisibility.canResume(),resumeExtent:b,computedExtent:c,updating:this.updating,suspended:this.suspended}};return b}(d.declared(t,r));c.maximumFeatureCount=-1;e([d.property()],
c.prototype,"drawingOrder",null);e([d.property()],c.prototype,"loadedGraphics",void 0);e([d.property()],c.prototype,"symbolsUpdating",void 0);e([d.property()],c.prototype,"hasDraped",null);e([d.property()],c.prototype,"controller",void 0);c=f=e([d.subclass("esri.views.3d.layers.FeatureLayerView3D")],c);var f;return c});