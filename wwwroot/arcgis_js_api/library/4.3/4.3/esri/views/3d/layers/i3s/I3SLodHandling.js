// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define(["require","exports"],function(m,n){return function(){function k(b,c,a){this.layerViewRequiredFunctions=b;this.layerViewOptionalFunctions=c;this.lodGlobalDirtyChanged=a;this._lodSwapNodeIndex={};this._lodSwapFeatureLookup={};this._lodSwapRootFeatureLookup={}}k.prototype.startNodeLoading=function(b,c,a,d,e,g){this._lodGlobalDirty=!1;this._lodMode=a;this._lodSwapNodeIndex={};this._lodSwapFeatureLookup={};this._lodSwapRootFeatureLookup={};this._nodeIndex=d;this._rootId=g;this._nodeTraversalState=
c;this._nodeIsVisible=b;if("swap"===this._lodMode){for(var h in e)b=e[h],this._nodeTraversalState(b.id).nodeHasLOD&&!this._nodeTraversalState(b.id).isChosenLOD&&(this._lodSwapNodeIndex[h]=b);this._lodSwapBuildUnmatchingFeatureLookups()}this.lodGlobalDirtyChanged(this._lodGlobalDirty)};k.prototype.cancelNodeLoading=function(){this._lodSwapNodeIndex={}};k.prototype.shouldLoadNode=function(b,c){var a=this._nodeTraversalState(b.id);c=a.nodeHasLOD;a=a.isChosenLOD;return"perLevel"!==this._lodMode?a||!c:
a||!c?!0:this.layerViewOptionalFunctions.traversalOptions.allowPartialOverlaps?this._someSubtreesIncomplete(b):this._allSubtreesIncomplete(b)};k.prototype.shouldSetPolygonOffset=function(b){return"perLevel"===this._lodMode?!this._nodeTraversalState(b.id).isChosenLOD:!1};k.prototype._allSubtreesIncomplete=function(b){if(this.layerViewRequiredFunctions.areAllBundlesLoaded(b))return!1;var c=!0;if(null!=b.children)for(var a=0;a<b.children.length;++a){var d=b.children[a];this._nodeIsVisible(d)&&(d=this._nodeIndex[d.id],
c=c&&(null==d||this._allSubtreesIncomplete(d)))}return c};k.prototype._someSubtreesIncomplete=function(b){if(this.layerViewRequiredFunctions.areAllBundlesLoaded(b))return!1;var c=!1;if(null!=b.children)for(var a=0;a<b.children.length;++a){var d=b.children[a];this._nodeIsVisible(d)&&(d=this._nodeIndex[d.id],c=c||null==d||this._allSubtreesIncomplete(d))}return c};k.prototype.setLodGlobalDirty=function(){this._lodGlobalDirty=!0;this.lodGlobalDirtyChanged(this._lodGlobalDirty)};k.prototype.finishedLevel=
function(b){"perLevel"===this._lodMode&&this._deleteUpToLevelRecurse(b-1,0,this._nodeIndex[this._rootId])};k.prototype._deleteUpToLevelRecurse=function(b,c,a){if(null!=a&&!(c>b)&&(this._nodeTraversalState(a.id).isChosenLOD||this.layerViewRequiredFunctions.removeNodeData(a),null!=a.children))for(var d=0;d<a.children.length;++d)this._deleteUpToLevelRecurse(b,c+1,this._nodeIndex[a.children[d].id])};k.prototype.lodSwapBundleLoaded=function(b,c,a){if(null!=a)if(null!=a.swapPairs&&0<Object.keys(a.swapPairs).length){if(null!=
c){b=a.swapPairs;a={};for(var d=0;d<c.length;d++)for(var e=c[d].features,g=0;g<e.length;g++)a[e[g].id]=!0;for(var h in b){c=b[h];d=[];e=c.features;for(g=0;g<e.length;g++)null!=a[e[g]]&&d.push(e[g]);this.layerViewRequiredFunctions.removeFeatures(c.node,c.features)}}}else{for(d in a.nodesHigherInTree)this.layerViewRequiredFunctions.removeNodeData(a.nodesHigherInTree[d]);for(d in a.nodesDeeperInTree)this.layerViewRequiredFunctions.removeNodeData(a.nodesDeeperInTree[d])}this.setLodGlobalDirty()};Object.defineProperty(k.prototype,
"requiresLODGlobalHandling",{get:function(){return"global"===this._lodMode&&null!=this._rootId&&(!0===this._lodGlobalDirty||this.layerViewRequiredFunctions.isOverMemory())},enumerable:!0,configurable:!0});k.prototype.lodGlobalHandling=function(){if(this.requiresLODGlobalHandling){var b=this._rootId;this._lodGlobalHandlingRecursion({id:b,mbs:null},this._nodeIndex,!1,!1,0);this._lodGlobalHandlingRecursionRemoveIntermediate(b,this._nodeIndex,!1,0);this._lodGlobalDirty=!1;this.lodGlobalDirtyChanged(this._lodGlobalDirty)}};
k.prototype.lodSwapBuildInfoForNode=function(b){if(!this._nodeTraversalState(b.id).nodeHasLOD)return null;if("swap"===this._lodMode){var c={},a={},d=!1,e=!1,g=b.id+"",h;for(h in this._lodSwapNodeIndex){var f=this._lodSwapNodeIndex[h];null!=this.layerViewRequiredFunctions.getAddedFeatures(f.id)&&(d=null===b.parentNode||0===(f.id+"").indexOf(g),e=null==f.parentNode||0===g.indexOf(f.id+""),!0===e&&(a[f.id]=f),!0===d&&(c[f.id]=f))}return{nodesHigherInTree:a,nodesDeeperInTree:c}}if("perLevel"===this._lodMode&&
this._nodeTraversalState(b.id).isChosenLOD)return c={},this._getNodesRecurse(b,c),{nodesHigherInTree:null,nodesDeeperInTree:c}};k.prototype._getNodesRecurse=function(b,c){if(null!=b.children)for(var a=0;a<b.children.length;++a){var d=b.children[a],e=this._nodeIndex[d.id];null!=e&&(c[d.id]=e,this._getNodesRecurse(e,c))}};k.prototype._lodSwapBuildUnmatchingFeatureLookups=function(){this._lodSwapFeatureLookup={};this._lodSwapRootFeatureLookup={};for(var b in this._lodSwapNodeIndex){var c=this._lodSwapNodeIndex[b],
a=this.layerViewRequiredFunctions.getAddedFeatures(c.id);if(null!=a)for(var d=0;d<a.length;d++){var e=a[d];this._lodSwapFeatureLookup[e.id]=c;null!=e.rootFeature&&(null==this._lodSwapRootFeatureLookup[e.rootFeature]&&(this._lodSwapRootFeatureLookup[e.rootFeature]=[]),this._lodSwapRootFeatureLookup[e.rootFeature].push({node:c,featureId:e.id}))}}};k.prototype._validateLodTreeVisibilities=function(){if(null!=this.layerViewOptionalFunctions.getAllAddedFeatures){var b=this.layerViewOptionalFunctions.getAllAddedFeatures();
console.debug("validating lod tree: ");var c={},a={},d=!0,e;for(e in b)for(var g=b[e],h=0;h<g.length;h++){var f=g[h];null!=c[f.id]&&c[f.id]!==e&&(console.debug("node "+e+" !! encountered feature "+f.id+" already in node "+c[f.id]),d=!1);null!=a[f.id]&&a[f.id]!==e&&(console.debug("node "+e+" !! encountered feature "+f.id+" already as rootFeature in node "+a[f.id]),d=!1);c[f.id]=e;null!=f.rootFeature&&a[f.rootFeature]!==e&&(null!=a[f.rootFeature]&&(console.debug("node "+e+" !! encountered rootFeature "+
f.rootFeature+" already in node "+a[f.rootFeature]),d=!1),null!=c[f.rootFeature]&&(console.debug("node "+e+" !! encountered rootFeature "+f.rootFeature+" already as feature"),d=!1),a[f.rootFeature]=e)}return d}};k.prototype._lodGlobalHandlingRecursion=function(b,c,a,d,e){var g=b.id,h=c[g];if(null==h)return a=null!=b.mbs?this._nodeIsVisible(b):!1,d||!a;g=this._nodeTraversalState(g);b=this._nodeIsVisible(h);var g=g.isChosenLOD,f=this.layerViewRequiredFunctions.isBundleAlreadyAddedToStage(h,0),k=!0;
if(null!=h.children)for(var l=0;l<h.children.length;++l)this._lodGlobalHandlingRecursion(h.children[l],c,f&&g||a,g||d,e+1)||(k=!1);c=this.layerViewRequiredFunctions.isOverMemory();f&&!g&&((d?a:k)||c)&&(this.setLodGlobalDirty(),this.layerViewRequiredFunctions.removeNodeData(h),f=!1);f&&this.layerViewOptionalFunctions.setPolygonOffset&&this.layerViewOptionalFunctions.setPolygonOffset(h,!(g&&!d));a=k||f;if(g&&f||!b||d)a=!0;g&&!f&&b&&(a=!1);return a};k.prototype._lodGlobalHandlingRecursionRemoveIntermediate=
function(b,c,a,d){var e=c[b];if(null!=e){var g=this.layerViewRequiredFunctions.isBundleAlreadyAddedToStage(e,0);b=this._nodeTraversalState(b).isChosenLOD;if(null!=e.children)for(var h=0;h<e.children.length;++h)this._lodGlobalHandlingRecursionRemoveIntermediate(e.children[h].id,c,g||a,d+1);a&&!b&&g&&(this.layerViewRequiredFunctions.removeNodeData(e),this.setLodGlobalDirty())}};return k}()});