// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define(["./UpsampleInfo","./tileUtils"],function(e,v){var m=Error("Abstract method called on TileAgentBase"),b=function(){};b.prototype.init=function(a,r,b,d){this.tile=a;this.layerIdx=r;this.layerClass=b;this._tileLayerInfo=a.getLayerInfo(r,b);this._dataRequested=null;this.suspended=d;if(!a.data)return(a=this._findAncestorWithData())?(this._setUpsamplingTile(a.tile),e.Pool.release(a)):(this._tileLayerInfo.upsampleFromTile&&e.Pool.release(this._tileLayerInfo.upsampleFromTile),this._tileLayerInfo.upsampleFromTile=
null),this._requestNext(!0)};b.prototype.dispose=function(){this._dataRequested&&(this._dataRequested.unrequestLayerData(this.layerIdx,this.layerClass,this),this._dataRequested=null);this._tileLayerInfo=this.tile=null};b.prototype.setSuspension=function(a){a!==this.suspended&&((this.suspended=a)?this._dataRequested&&(this._dataRequested.unrequestLayerData(this.layerIdx,this.layerClass,this),this._dataRequested=null):this._tileLayerInfo.data||this.update())};b.prototype.update=function(){var a=this._findAncestorWithData();
a&&this._tileLayerInfo.upsampleFromTile&&a.tile!==this._tileLayerInfo.upsampleFromTile.tile?this._setUpsamplingTile(a.tile):a&&e.Pool.release(a);return this._requestNext()};b.prototype.dataArrived=function(a){throw m;};b.prototype.dataMissing=function(a){this._dataRequested=null;this._agentDone()};b.prototype._agentDone=function(){this.tile.agentDone(this.layerIdx,this.layerClass);this.dispose()};b.prototype._requestNext=function(a){if(this.suspended)return!0;var b=this._findNextDownload();if(this._dataRequested){if(b===
this._dataRequested)return!0;this._dataRequested.unrequestLayerData(this.layerIdx,this.layerClass,this);this._dataRequested=null}b?b.requestLayerData(this.layerIdx,this.layerClass,this)&&(this._dataRequested=b):a||this._agentDone();return!!this._dataRequested};b.prototype._findNextDownload=function(){for(var a,b=this.layerIdx,f=this.layerClass,d=this.tile.parentSurface.layerViewByIndex(b,f),g=d.minDataLevel,h=d.maxDataLevel,k=this._desiredMinLevelDelta(),e=this.START_LOADING_LEVEL_DELTA+k,m=this.SCALE_RANGE_ENABLED,
c=this.tile,p=c.lij[0],q=0,w=this._tileLayerInfo.upsampleFromTile?this._tileLayerInfo.upsampleFromTile.tile.lij[0]:-1,n=this.tile.parentSurface,l=n.getTilemapTile(c),n=n.tilemapStats,t=!1;c&&(q<=e||!a)&&(!m||v.fallsWithinLayer(c,d,!1))&&c.lij[0]>=g;){var u=c.layerInfo[f][b];if(u.data&&q>=k){c.lij[0]>w&&this._setUpsamplingTile(c);break}l&&!l.tileDataAvailable(c,b,f)?t=!0:c.lij[0]<=h&&!u.data&&(a=c);c=c.parent;l=l?l.parent:null;q++}a&&p-a.lij[0]<k&&this._tileLayerInfo.upsampleFromTile&&(a=null);!a&&
t&&n.tilesNotPresent++;return a};b.prototype._findAncestorWithData=function(){return p(this.tile,this.layerIdx,this.layerClass,1,0,0,0)};var p=function(a,b,f,d,g,h,k){if(!a.parent||6<k)return null;d*=.5;g*=.5;h*=.5;a.lij[2]&1&&(g+=.5);0===(a.lij[1]&1)&&(h+=.5);return a.parent.hasLayerData(b,f)?(b=e.Pool.acquire(),b.init(a.parent,g,h,d),b):p(a.parent,b,f,d,g,h,k+1)};b.prototype._desiredMinLevelDelta=function(){throw m;};b.prototype.START_LOADING_LEVEL_DELTA=4;b.prototype.SCALE_RANGE_ENABLED=!1;return b});