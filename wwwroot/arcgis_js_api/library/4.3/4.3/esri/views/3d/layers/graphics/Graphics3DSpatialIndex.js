// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports dojo/Deferred ../../../../processors/SpatialIndex ../../../../geometry/SpatialReference ../../../../geometry/support/webMercatorUtils".split(" "),function(n,p,l,m,h,k){return function(){function a(){var b=this;this.spatialIndex=new m;this.spatialIndexNumPendingQueries=this.spatialIndexNumGraphics=0;this.graphicsCore=this.viewSR=this.layer=this.layerView=null;this._readyDfd=new l;var g=function(b){return b.workerClient&&b.workerClient.worker};if(g(this.spatialIndex))this._readyDfd.resolve();
else this.spatialIndex.on("start",function(){g(b.spatialIndex)&&b._readyDfd.resolve()})}a.prototype.initialize=function(b,g,a,c){this.layerView=b;this.layer=g;this.viewSR=a;this.graphicsCore=c};a.prototype.destroy=function(){this.spatialIndex&&(this.spatialIndex.destroy(),this.spatialIndex=null);this.graphicsCore=this.layerView=this.viewSR=null};a.prototype.numNodesUpdating=function(){return 0};a.prototype.isUpdating=function(){return 0<this.spatialIndexNumPendingQueries};a.prototype.hasGraphics=
function(){return 0<this.spatialIndexNumGraphics};a.prototype.intersects=function(b,a,d){var c=this;this.hasGraphics()&&(this.spatialIndexNumPendingQueries++,this.spatialIndex.intersects(b,void 0,void 0,!0).then(function(b){c.spatialIndexNumPendingQueries--;d(b.results,b.results.length);c.layerView._evaluateUpdatingState()}))};a.prototype.shouldAddToSpatialIndex=function(b,a,d){return d||a.mustAlignToTerrain()};a.prototype.addGraphicsToSpatialIndex=function(b){if(this.layerView.loadedGraphics)for(var a=
this.layerView.loadedGraphics.toArray(),d=a.length,c=0;c<d;c++){var f=a[c],e=this.graphicsCore.getGraphics3DGraphicById(f.uid);e&&!e.addedToSpatialIndex&&this.shouldAddToSpatialIndex(f,e,b)&&this.addGraphicToSpatialIndex(f,e)}};a.prototype.addGraphicToSpatialIndex=function(b,a){var d=b.geometry.spatialReference,c=this.viewSR,f={id:b.uid,geometry:null};if(d.equals(c))f.geometry=b.geometry.toJSON();else{var e=void 0;if(d.wkid===h.WGS84.wkid&&c.isWebMercator)e=k.geographicToWebMercator(b.geometry);else if(d.isWebMercator&&
c.wkid===h.WGS84.wkid)e=k.webMercatorToGeographic(b.geometry);else return console.warn("Cannot convert graphic geometry to map spatial reference, elevation and scale updates are disabled"),!1;f.geometry=e.toJSON()}this.spatialIndexNumGraphics++;this.spatialIndex.runProcess([f],this.layer.id);return a.addedToSpatialIndex=!0};a.prototype.whenLoaded=function(){return this._readyDfd.promise};return a}()});