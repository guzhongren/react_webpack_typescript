// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ../../support/earthUtils ../../support/projectionUtils ../../support/intersectionUtils ../../lib/glMatrix".split(" "),function(k,x,l,q,m,n){var e=n.vec3d,p=n.vec4d,r=-.3*l.earthRadius;k=.5*Math.PI;var t=k/Math.PI*180,u=k*l.earthRadius,v=.9*l.earthRadius,w=function(){function c(){this.extent=Array(4);this.planes=Array(4);this.maxSpan=0;this.center={origin:e.create(),direction:e.create()};for(var a=0;4>a;a++)this.extent[a]={origin:e.create(),originLength:0,direction:e.create(),
cap:{next:null,direction:e.create()}},this.planes[a]=p.create();this.planes[4]=p.create()}c.prototype.update=function(a,c,b,g,f,h){var d=this.extent;e.set3(a[0],a[1],h,d[0].origin);e.set3(a[2],a[1],h,d[1].origin);e.set3(a[2],a[3],h,d[2].origin);e.set3(a[0],a[3],h,d[3].origin);if(!f)for(f=0;4>f;f++)q.vectorToVector(d[f].origin,g,d[f].origin,b);e.add(d[0].origin,d[2].origin,this.center.origin);e.scale(this.center.origin,.5);c(this.center.origin,this.center.direction);for(f=0;4>f;f++)b=d[f],c(b.origin,
b.direction),b.originLength=e.length(b.origin),g=d[3===f?0:f+1],b.cap.next=g.origin,e.direction(g.origin,b.origin,b.cap.direction),this._computePlane(b.cap.direction,b.direction,b.origin,this.planes[f]);this._computePlane(d[1].cap.direction,d[0].cap.direction,d[0].origin,this.planes[4]);this.maxSpan=Math.max(Math.abs(a[0]-a[2]),Math.abs(a[1]-a[3]))};c.prototype.isVisibleInFrustumGlobal=function(a){if(0>e.dot(this.center.direction,a.direction))return!0;for(var d=0;4>d;d++)if(0>e.dot(this.extent[d].direction,
a.direction))return!0;return!1};c.prototype.isVisibleInFrustum=function(a,d,b){if("global"===a.viewingMode){if(this.maxSpan>(a.spatialReference.isWGS84?t:u))return!0;if(d.altitude()>=v)return this.isVisibleInFrustumGlobal(d)}for(a=0;a<this.extent.length;a++)if(b=this.extent[a],m.frustumRay(d.planes,b.origin,null,b.direction)||m.frustumLineSegment(d.planes,b.origin,b.cap.next,b.cap.direction))return!0;for(a=0;a<d.lines.length;a++)if(b=d.lines[a],m.frustumLineSegment(this.planes,b.origin,b.endpoint,
b.direction))return!0;return!1};c.prototype._computePlane=function(a,d,b,c){e.cross(a,d,c);c[3]=-e.dot(c,b)};return c}();return function(){function c(){this.frustumVisibilityDirty=this.frustumVisibility=!0;this.extent=null;this.extentEngine=new w;this.extentEngineDirty=!0;this.renderSREqualsViewSR=null;this._isVisibleBelowSurface=!1;this.layerView=null}c.prototype.initialize=function(a){this.layerView=a;this.renderSREqualsViewSR=a.view.renderSpatialReference.equals(a.view.spatialReference)};c.prototype.destroy=
function(){this.extentEngine=this.extent=this.layerView=null};c.prototype.needsIdleUpdate=function(){return this.frustumVisibilityDirty};c.prototype.canResume=function(){return this.frustumVisibility};c.prototype.setExtent=function(a){this.extent=a;this.frustumVisibilityDirty=this.extentEngineDirty=!0};c.prototype.viewChange=function(){this.frustumVisibilityDirty=!0};c.prototype.elevationBoundsChange=function(){this.extentEngineDirty=this.frustumVisibilityDirty=!0};Object.defineProperty(c.prototype,
"isVisibleBelowSurface",{set:function(a){this._isVisibleBelowSurface=a;this.extentEngineDirty=this.frustumVisibilityDirty=!0},enumerable:!0,configurable:!0});c.prototype.idleUpdate=function(a){!a.done()&&this.frustumVisibilityDirty&&(this.updateSuspendFrustumVisible(),this.frustumVisibilityDirty=!1)};c.prototype.updateExtentEngine=function(){if(this.extentEngineDirty){this.extentEngineDirty=!1;var a=this.layerView.view,d=a.renderCoordsHelper.worldUpAtPosition,b;if(this._isVisibleBelowSurface)b=r;
else{b=a.basemapTerrain.getElevationBounds();var c=b[0];b=c-Math.max(1,(b[1]-c)*(1.2-1))}this.extentEngine.update(this.extent,d,a.renderSpatialReference,a.spatialReference,this.renderSREqualsViewSR,b)}};c.prototype.updateSuspendFrustumVisible=function(){if(this.extent){this.updateExtentEngine();var a=this.layerView.view.getFrustum(),a=this.extentEngine.isVisibleInFrustum(this.layerView.view,a,this._isVisibleBelowSurface);a!==this.frustumVisibility&&(this.frustumVisibility=a,this.layerView._notifySuspendedChange())}else this.frustumVisibility=
!0};return c}()});