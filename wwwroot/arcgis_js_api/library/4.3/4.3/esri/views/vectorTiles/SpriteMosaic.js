// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ./Rect ./GeometryUtils ./RectangleBinPack ../webgl/Texture".split(" "),function(u,v,r,q,l,t){return function(){function e(a,c,b){void 0===b&&(b=0);this._size=[];this._mosaicsData=[];this._textures=[];this._dirties=[];this._pageHeight=this._pageWidth=this._currentPage=this._maxItemSize=0;this._mosaicRects={};this.pixelRatio=1;(0>=a||0>=c)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!");this._pageWidth=a;this._pageHeight=c;0<b&&(this._maxItemSize=
b);this._binPack=new l(a,c)}e.prototype.getWidth=function(a){return a>=this._size.length?-1:this._size[a][0]};e.prototype.getHeight=function(a){return a>=this._size.length?-1:this._size[a][1]};e.prototype.setSpriteSource=function(a){this._dispose();this.pixelRatio=a.devicePixelRatio;0===this._mosaicsData.length&&(this._binPack=new l(this._pageWidth,this._pageHeight),this._mosaicsData[0]=new Uint32Array(Math.floor(this._pageWidth)*Math.floor(this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,
this._pageHeight]),this._textures.push(void 0));this._sprites=a};e.prototype.getSpriteItem=function(a,c){void 0===c&&(c=!1);var b=this._mosaicRects[a];if(b)return b;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;var d=this._sprites.getSpritePosition(a);if(!d||!d.width||!d.height)return null;var b=this._allocateImage(d.width,d.height),e=b[0],h=b[1],f=b[2];if(0>=e.width)return null;b={rect:e,width:d.width,height:d.height,sdf:d.sdf,pixelRatio:d.pixelRatio,page:h};this._copy(e,d,h,
f,c);return this._mosaicRects[a]=b};e.prototype.getSpriteItems=function(a){for(var c={},b=0;b<a.length;b++){var d=a[b];c[d]=this.getSpriteItem(d)}return c};e.prototype.getMosaicItemPosition=function(a,c){c=(a=this.getSpriteItem(a,c))&&a.rect;if(!c)return null;c.width=a.width;c.height=a.height;return{size:[a.width,a.height],tl:[(c.x+1)/this._size[a.page][0],(c.y+1)/this._size[a.page][1]],br:[(c.x+1+a.width)/this._size[a.page][0],(c.y+1+a.height)/this._size[a.page][1]],page:a.page}};e.prototype.bind=
function(a,c,b,d){void 0===b&&(b=0);void 0===d&&(d=0);this._textures[b]||(this._textures[b]=new t(a,{pixelFormat:6408,dataType:5121,width:this._size[b][0],height:this._size[b][1]},new Uint8Array(this._mosaicsData[b].buffer)));var e=this._textures[b];e.setSamplingMode(c);a.bindTexture(e,d);this._dirties[b]&&e.setData(new Uint8Array(this._mosaicsData[b].buffer));this._dirties[b]=!1};e._copyBits=function(a,c,b,d,e,h,f,g,m,n,k){var p=d*c+b;f=g*h+f;if(k)for(f-=h,k=-1;k<=n;k++,p=((k+n)%n+d)*c+b,f+=h)for(g=
-1;g<=m;g++)e[f+g]=a[p+(g+m)%m];else for(k=0;k<n;k++){for(g=0;g<m;g++)e[f+g]=a[p+g];p+=c;f+=h}};e.prototype._copy=function(a,c,b,d,l){if(this._sprites&&"loaded"===this._sprites.loadStatus&&!(b>=this._mosaicsData.length)){var h=new Uint32Array(this._sprites.image.buffer),f=this._mosaicsData[b];f&&h||console.error("Source or target images are uninitialized!");e._copyBits(h,this._sprites.width,c.x,c.y,f,d[0],a.x+1,a.y+1,c.width,c.height,l);this._dirties[b]=!0}};e.prototype._allocateImage=function(a,
c){a+=2;c+=2;var b=Math.max(a,c);if(this._maxItemSize&&this._maxItemSize<b){var b=Math.pow(2,Math.ceil(q.log2(a))),d=Math.pow(2,Math.ceil(q.log2(c)));a=new r(0,0,a,c);this._mosaicsData.push(new Uint32Array(b*d));this._dirties.push(!0);this._size.push([b,d]);this._textures.push(void 0);return[a,this._mosaicsData.length-1,[b,d]]}b=this._binPack.allocate(a+(a%4?4-a%4:0),c+(c%4?4-c%4:0));return 0>=b.width?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=
this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new l(this._pageWidth,this._pageHeight),this._allocateImage(a,c)):[b,this._currentPage,[this._pageWidth,this._pageHeight]]};e.prototype._dispose=function(){this._binPack=null;this._mosaicRects={}};return e}()});