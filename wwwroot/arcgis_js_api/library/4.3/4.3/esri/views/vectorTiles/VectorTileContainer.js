// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/extendsHelper dojo/has ../../core/libs/gl-matrix/vec3 ../../core/libs/gl-matrix/mat4 ../2d/engine/Container ./renderers/Renderer ./GeometryUtils ./StencilClipGenerator".split(" "),function(u,v,m,n,l,f,p,q,r,t){return function(g){function c(){var a=g.call(this)||this;a.isInitialized=!1;a._displayWidth=0;a._displayHeight=0;a._clip=new t;a._tileCoordinateScale=l.create();a._orientationVec=l.create();a._displayScale=l.create();a._orientationVec.set([0,0,1]);
a._defaultTransform=f.create();return a}m(c,g);c.prototype.initialize=function(a,b,c,e){this._renderer=new q;this._renderer.initialize(a,b);this._tileInfoView=e;this._tileInfo=c;this.isInitialized=!0};c.prototype.prepareChildrenRenderParameters=function(a){var b=a.state;if(!b||!this._tileInfo||!this.isInitialized)return a;a.displayLevel=this._tileInfo.scaleToZoom(b.scale);a.requiredLevel=this._tileInfoView.getClosestInfoForScale(b.scale).level;a.renderer=this._renderer;return a};c.prototype.renderChildren=
function(a){if(0!==this.children.length&&this.isInitialized&&a&&a.state){this.sortChildren(function(a,b){return b.resolution-a.resolution});this._clip.update(this.children);this._updateTilesTransform(a.state,this._tileInfoView.getClosestInfoForScale(a.state.scale).level);var b=a.context;b.setDepthWriteEnabled(!0);this._renderer.setStateParams(a.state,a.devicePixelRatio,a.displayLevel);this._renderer.drawClippingMasks(b,this.children);b.setStencilWriteMask(0);b.setBlendFunctionSeparate(1,771,1,771);
b.setStencilOp(7680,7680,7681);b.setDepthFunction(515);b.setBlendingEnabled(!1);b.setStencilTestEnabled(!0);b.setDepthTestEnabled(!0);b.setDepthWriteEnabled(!0);a.drawphase=0;g.prototype.renderChildren.call(this,a);b.setDepthWriteEnabled(!1);b.setBlendingEnabled(!0);a.drawphase=1;g.prototype.renderChildren.call(this,a);a.drawphase=2;g.prototype.renderChildren.call(this,a);b.setStencilTestEnabled(!1);b.setDepthTestEnabled(!1);if(n("esri-vector-tiles-debug")){a=0;for(var c=this.children;a<c.length;a++){var e=
c[a];e.attached&&e.visible&&this._renderer.renderTileInfo(b,e)}}this._renderer.needsRedraw()&&this.requestRender()}};c.prototype.attachChild=function(a,b){return a.attach(b)};c.prototype.detachChild=function(a,b){a.detach(b)};c.prototype.renderChild=function(a,b){a.render(b)};c.prototype._updateTilesTransform=function(a,b){var c=1/a.width,e=1/a.height,h=[0,0];this._calculateRelativeViewProjMat(this._tileInfo.lods[b].resolution,a.resolution,a.rotation,this._tileInfo.size[1],4096,a.width,a.height,this._defaultTransform);
for(var k=0,f=this.children;k<f.length;k++){var d=f[k];a.toScreen(h,d.coords);h[1]=a.height-h[1];d.tileTransform.displayCoord[0]=2*h[0]*c-1;d.tileTransform.displayCoord[1]=2*h[1]*e-1;d.key.level===b&&4096===d.coordRange?d.tileTransform.transform.set(this._defaultTransform):this._calculateRelativeViewProjMat(this._tileInfo.lods[d.key.level].resolution,a.resolution,a.rotation,this._tileInfo.size[1],d.coordRange,a.width,a.height,d.tileTransform.transform)}};c.prototype._calculateRelativeViewProjMat=
function(a,b,c,e,h,k,g,d){var l=.125;512!==e&&4096!==h&&(l=e/h);a=a/b*l;this._tileCoordinateScale.set([a,a,1]);if(k!==this._displayWidth||g!==this._displayHeight)this._displayScale.set([2/k,-2/g,1]),this._displayWidth=k,this._displayHeight=g;f.identity(d);f.scale(d,d,this._tileCoordinateScale);f.rotate(d,d,-c*r.C_DEG_TO_RAD,this._orientationVec);f.scale(d,d,this._displayScale);f.transpose(d,d)};return c}(p)});