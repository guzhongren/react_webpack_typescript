// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define(["require","exports","./Geometry","./GeometryUtils","./Conflict"],function(w,m,r,d,D){w=function(){return function(d,a,b,g,e){void 0===b&&(b=0);void 0===g&&(g=-1);void 0===e&&(e=A);this.x=d;this.y=a;this.angle=b;this.segment=g;this.minzoom=e}}();m.Anchor=w;w=function(){return function(d,a,b){this.glyph=d;this.x=a;this.y=b}}();m.ShapedGlyph=w;var P=function(){return function(p,a,b,g,e,f){void 0===g&&(g=!1);void 0===e&&(e=A);void 0===f&&(f=d.C_INFINITY);this.anchor=p;this.labelAngle=a;this.glyphAngle=
b;this.upsideDown=g;this.minzoom=e;this.maxzoom=f}}(),Q=function(){return function(d,a,b,g,e,f,r,q,B){this.tl=d;this.tr=a;this.bl=b;this.br=g;this.mosaicRect=e;this.labelAngle=f;this.anchor=r;this.minzoom=q;this.maxzoom=B}}();m.PlacedSymbol=Q;var R=function(){return function(d,a){this.footprint=d;this.shapes=a}}();m.Placement=R;var A=.5;w=function(){function p(a){this.mapAngle=a;this._conflictEngine=new D.ConflictEngine(a)}p.prototype.getIconPlacement=function(a,b,g,e,f,L){var q=b.width/b.pixelRatio,
B=b.height/b.pixelRatio;e=f.offset[0]-q/2;var C=f.offset[1]-B/2,q=e+q,B=C+B,y=b.rect,k=e-1,h=C-1,c=k+y.width/b.pixelRatio,l=h+y.height/b.pixelRatio;b=new r.Point(k,h);var t=new r.Point(c,l),k=new r.Point(k,l),c=new r.Point(c,h),l=f.rotate*d.C_DEG_TO_RAD,h=1===f.rotationAlignment;0<=a.segment&&!h&&(l+=a.angle);if(0!==l){var n=Math.cos(l),u=Math.sin(l);b.rotate(n,u);t.rotate(n,u);k.rotate(n,u);c.rotate(n,u)}n=8*f.padding;u=new r.Point(a.x,a.y);a=new D.Footprint(this.mapAngle,n,h);a.addBox(u,new D.Box(e,
C,q,B),g,l,A,d.C_INFINITY);g=new Q(b,c,k,t,y,0,u,A,d.C_INFINITY);g=new R(a,[g]);e=A;f.allowOverlap||(e=this._conflictEngine.getMinZoom(g.footprint,e,L,h));a.minzoom=e;return g};p.prototype.getTextPlacement=function(a,b,g,e,f,L,q,B){for(var C=new r.Point(a.x,a.y),y=q.rotate*d.C_DEG_TO_RAD,k=0===q.rotationAlignment,h=q.keepUpright,c=A,l=!k,t=l?0:a.angle,n=0<=a.segment&&k,u=new D.Footprint(this.mapAngle,8*q.padding,l),p=[],w=!n,E=Number.POSITIVE_INFINITY,F=Number.NEGATIVE_INFINITY,m=E,J=F,da=n?h:k&&
h,ea=[],S,T=0;T<g.length;T++){var z=g[T],v=e[z.glyph];if(v){var H=v.rect;if(!(!H||0>=H.width||0>=H.height)){var G=v.metrics;w&&(S&&S!==z.y&&(u.addBox(C,new D.Box(E,m,F,J),f,y,A,d.C_INFINITY),E=Number.POSITIVE_INFINITY,F=Number.NEGATIVE_INFINITY,m=E,J=F),S=z.y);var I=[];if(n){if(v=(b.x+z.x+G.left-3+.5*v.metrics.width)*f,c=this._placeGlyph(a,c,v,L,a.segment,1,I),h&&(c=this._placeGlyph(a,c,v,L,a.segment,-1,I)),2<=c)break}else I.push(new P(C,t,t)),k&&h&&I.push(new P(C,t+d.C_PI,t+d.C_PI,!0));for(var v=
z.x+b.x+G.left,z=z.y+b.y-G.top,U=v+G.width,G=z+G.height,K=new r.Point(v-3,z-3),V=new r.Point(K.x+H.width,K.y+H.height),fa=new r.Point(K.x,V.y),ga=new r.Point(V.x,K.y),W=0;W<I.length;W++){var x=I[W],Z=K.clone(),aa=fa.clone(),ba=ga.clone(),ca=V.clone(),X=z,Y=G,M=x.glyphAngle+y;if(0!==M){var N=Math.cos(M),O=Math.sin(M);Z.rotate(N,O);ca.rotate(N,O);aa.rotate(N,O);ba.rotate(N,O)}p.push(new Q(Z,ba,aa,ca,H,x.labelAngle,x.anchor,x.minzoom,x.maxzoom));if(!da||this._legible(x.labelAngle))w?(v<E&&(E=v),X<m&&
(m=X),U>F&&(F=U),Y>J&&(J=Y)):2>x.minzoom&&u.addBox(x.anchor,new D.Box(v,X,U,Y),f,M,x.minzoom,x.maxzoom);ea.push(x)}}}}if(2<=c)return null;w&&u.addBox(C,new D.Box(E,m,F,J),f,y,A,d.C_INFINITY);a=new R(u,p);q.allowOverlap||(c=this._conflictEngine.getMinZoom(a.footprint,c,B,l));u.minzoom=c;return a};p.prototype.add=function(a){this._conflictEngine.add(a.footprint)};p.prototype._legible=function(a){a=d.radToByte(a);return 65>a||193<=a};p.prototype._placeGlyph=function(a,b,g,e,f,m,q){var p=0>m?d.positiveMod(a.angle+
d.C_PI,d.C_2PI):a.angle,w=this._legible(p),y=0;0>g&&(m*=-1,g*=-1,y=d.C_PI);0<m&&++f;a=new r.Point(a.x,a.y);var k=e[f],h=d.C_INFINITY;if(e.length<=f)return h;for(;;){var c=k.x-a.x,l=k.y-a.y,t=Math.sqrt(c*c+l*l),n=Math.max(g/t,b),c=d.positiveMod(Math.atan2(l/t,c/t)+y,d.C_2PI);q.push(new P(a,p,c,w,n,h));if(n<=b)return n;a=k.clone();do{f+=m;if(e.length<=f||0>f)return n;k=e[f]}while(a.isEqual(k));h=k.x-a.x;c=k.y-a.y;l=Math.sqrt(h*h+c*c);h*=t/l;c*=t/l;a.x-=h;a.y-=c;h=n}};return p}();m.PlacementEngine=w});