// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.3/esri/copyright.txt for details.
//>>built
define("require exports ../../request ../Portal ./jsonContext ../../renderers/support/styleUtils ../../core/Error ../../core/promiseUtils ../../core/requireUtils ../../layers/GroupLayer".split(" "),function(m,n,p,q,r,t,h,g,u,v){function w(b){var c=b.instance,a=c.portalItem,d=a.url,f=a.title,e=r.createForItem(a);if(c.isInstanceOf(v))return c.read({title:f},e),x(c,b);d&&c.read({url:d},e);return k(b).then(function(a){a&&c.read(a,e);c.read({title:f},e);return t.loadStyleRenderer(c,e)})}function x(b,c){var a;
a=b.portalItem.type;switch(a){case "Feature Service":a="FeatureLayer";break;case "Stream Service":a="StreamLayer";break;case "Scene Service":a="SceneLayer";break;case "Feature Collection":a="FeatureLayer";break;default:throw new h("portal:unsupported-item-type-as-group","The item type '"+a+"' is not supported as a 'GroupLayer'");}var d;return u.when(m,"../../layers/"+a).then(function(a){d=a;return k(c)}).then(function(a){return a&&Array.isArray(a.layers)?l(b,d,a,c):y(b,d,c)})}function y(b,c,a){return b.portalItem.url?
p(b.portalItem.url,{responseType:"json",callbackParamName:"callback",query:{f:"json"}}).then(function(d){if((d=d.data)&&Array.isArray(d.layers))return d=d.layers.map(function(a){return{id:a.id,name:a.name}}),l(b,c,{layers:d},a)}):g.resolve()}function l(b,c,a,d){var f=a.showLegend;a=a.layers.slice();a.reverse();a.forEach(function(a){var d=new c({portalItem:b.portalItem,layerId:a.id,sublayerTitleMode:"service-name"});if("Feature Collection"===b.portalItem.type){var e={origin:"portal-item",portal:b.portalItem.portal||
q.getDefault()};d.read(a,e);null!=f&&d.read({showLegend:f},e)}b.add(d)})}function k(b){if(!1===b.supportsData)return g.resolve();var c=b.instance;return c.portalItem.fetchData().otherwise(function(){return null}).then(function(a){var b,f;f="stream"===c.type?!1:"layerId"in c;if(f){f=!0;if(a&&Array.isArray(a.layers)){null==c.layerId&&(c.layerId=a.layers[0].id);for(var e=0;e<a.layers.length;e++)if(a.layers[e].id===c.layerId){b=a.layers[e];break}b&&(1===a.layers.length&&(f=!1),null!=a.showLegend&&(b.showLegend=
a.showLegend))}f&&"service-name"!==c.sublayerTitleMode&&(c.sublayerTitleMode="item-title-and-service-name");return b}return a})}n.load=function(b){var c=b.instance.portalItem;return c&&c.id?c.load().then(function(){var a=b.instance.portalItem;if(-1===b.supportedTypes.indexOf(a.type))throw new h("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:a.type,expectedType:b.supportedTypes.join(", ")});}).then(function(){return w(b)}):g.resolve()}});