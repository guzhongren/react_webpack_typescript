/*! ArcGIS API for JavaScript 4.3 | Copyright (c) 2017 Esri. All rights reserved. | http://www.esri.com/legal/privacy | https://developers.arcgis.com/terms/faq */
define(["dojo/_base/declare","dojo/_base/lang","dojo/query","dojo/dom-construct","dojo/on","dojo/_base/array","dojo/Evented","Quoin/Base"],function(t,e,s,a,i,h,n,r){var o=/^[#\/]|\s+$/g,c=/^\/+|\/+$/g,l=/msie [\w.]+/,d=/\/$/,g=t("Quoin.History",[n,r],{interval:50,started:!1,handlers:[],getHash:function(){var t=window.location.href.match(/#(.*)$/);return t?t[1]:""},getFragment:function(t,e){if(null==t)if(this._hasPushState||!this._wantsHashChange||e){t=window.location.pathname;var s=this.root.replace(d,"");t.indexOf(s)||(t=t.substr(s.length))}else t=this.getHash();return t.replace(o,"")},start:function(t){if(this.started)throw new Error("Backbone.history has already been started");this.started=!0,this.options=e.mixin({},{root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var s=this.getFragment(),h=document.documentMode,n=l.exec(navigator.userAgent.toLowerCase())&&(!h||h<=7);this.root=("/"+this.root+"/").replace(c,"/"),n&&this._wantsHashChange&&(this.iframe=a("iframe",{src:"javascript:0",tabIndex:-1,style:"display:none;"},"body"),this.navigate(s)),this._hasPushState?this._handler=i(window,"popstate",e.hitch(this,this.checkUrl)):this._wantsHashChange&&"onhashchange"in window&&!n?this._handler=i(window,"hashchange",e.hitch(this,this.checkUrl)):this._wantsHashChange&&(this._checkUrlInterval=setInterval(e.hitch(this,this.checkUrl),this.interval)),this.fragment=s;var r=window.location,d=r.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!d?(this.fragment=this.getFragment(null,!0),window.location.replace(this.root+window.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&d&&r.hash&&(this.fragment=this.getHash().replace(o,""),window.history.replaceState({},document.title,this.root+this.fragment+r.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){this._handler.remove(),clearInterval(this._checkUrlInterval),g.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(t){var e=this.getFragment();return e===this.fragment&&this.iframe&&(e=this.getFragment(this.getHash(this.iframe))),e!==this.fragment&&(this.iframe&&this.navigate(e),void(this.loadUrl()||this.loadUrl(this.getHash())))},loadUrl:function(t){var e=this.fragment=this.getFragment(t),s=h.some(this.handlers,function(t){if(t.route.test(e))return t.callback(e),!0});return s},navigate:function(t,e){if(this.started&&(e&&e!==!0||(e={trigger:e}),t=this.getFragment(t||""),this.fragment!==t)){this.fragment=t;var s=this.root+t;if(this._hasPushState)window.history[e.replace?"replaceState":"pushState"]({},document.title,s);else{if(!this._wantsHashChange)return window.location.assign(s);this._updateHash(window.location,t,e.replace),this.iframe&&t!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,t,e.replace))}e.trigger&&this.loadUrl(t)}},_updateHash:function(t,e,s){if(s){var a=t.href.replace(/(javascript:|#).*$/,"");t.replace(a+"#"+e)}else t.hash="#"+e}});return new g});